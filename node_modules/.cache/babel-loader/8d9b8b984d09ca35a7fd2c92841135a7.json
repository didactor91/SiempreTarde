{"ast":null,"code":"import normalize from '../common/normalize';\nimport validate from '../common/validate';\nimport userApi from '../data/user-api';\nimport { LogicError, DirectionError, PasswordError, NoDataError } from '../common/errors';\nimport iBusApi from '../data/ibus-api';\nimport transitApi from '../data/transit-api';\nconst logic = {\n  set __userId__(id) {\n    sessionStorage.userId = id;\n  },\n\n  get __userId__() {\n    return normalize.undefinedOrNull(sessionStorage.userId);\n  },\n\n  set __userToken__(token) {\n    sessionStorage.userToken = token;\n  },\n\n  get __userToken__() {\n    return normalize.undefinedOrNull(sessionStorage.userToken);\n  },\n\n  get isUserLoggedIn() {\n    return !!(this.__userId__ && this.__userToken__);\n  },\n\n  registerUser(name, surname, email, password, password2) {\n    validate.arguments([{\n      name: 'name',\n      value: name,\n      type: 'string',\n      notEmpty: true\n    }, {\n      name: 'surname',\n      value: surname,\n      type: 'string',\n      notEmpty: true\n    }, {\n      name: 'email',\n      value: email,\n      type: 'string',\n      notEmpty: true\n    }, {\n      name: 'password',\n      value: password,\n      type: 'string',\n      notEmpty: true\n    }, {\n      name: 'password2',\n      value: password2,\n      type: 'string',\n      notEmpty: true\n    }]);\n    validate.email(email);\n    if (password !== password2) throw new PasswordError(\"Password don't match\");\n    return userApi.create(email, password, {\n      name,\n      surname\n    }).then(response => {\n      if (response.status === 'OK') return;\n      throw new LogicError(response.error);\n    });\n  },\n\n  loginUser(email, password) {\n    validate.arguments([{\n      name: 'email',\n      value: email,\n      type: 'string',\n      notEmpty: true\n    }, {\n      name: 'password',\n      value: password,\n      type: 'string',\n      notEmpty: true\n    }]);\n    validate.email(email);\n    return userApi.authenticate(email, password).then(response => {\n      if (response.status === 'OK') {\n        const _response$data = response.data,\n              id = _response$data.id,\n              token = _response$data.token;\n        this.__userId__ = id;\n        this.__userToken__ = token;\n      } else throw new LogicError(response.error);\n    });\n  },\n\n  retrieveUser() {\n    return userApi.retrieve(this.__userId__, this.__userToken__).then(response => {\n      if (response.status === 'OK') {\n        const _response$data2 = response.data,\n              name = _response$data2.name,\n              surname = _response$data2.surname,\n              email = _response$data2.username;\n        return {\n          name,\n          surname,\n          email\n        };\n      } else throw new LogicError(response.error);\n    });\n  },\n\n  logoutUser() {\n    sessionStorage.clear();\n  },\n\n  addFavorites() {//TODO\n  },\n\n  retrieveFavorites() {//TODO\n  },\n\n  retrieveBusLines(line_id) {\n    validate.arguments([{\n      name: 'line_id',\n      value: line_id,\n      type: 'number',\n      notEmpty: true,\n      optional: true\n    }]);\n    return transitApi.retrieveBusLine(line_id).then(response => {\n      const features = response.features;\n      return features.map(({\n        properties: {\n          \"CODI_LINIA\": line_id,\n          \"NOM_LINIA\": name_line,\n          \"DESC_LINIA\": desc_line,\n          \"ORIGEN_LINIA\": origin_line,\n          \"DESTI_LINIA\": dest_line,\n          \"COLOR_LINIA\": color_line\n        }\n      }) => {\n        return {\n          line_id,\n          name_line,\n          desc_line,\n          origin_line,\n          dest_line,\n          color_line\n        };\n      });\n    });\n  },\n\n  retrieveBusLineRoute(line_id) {\n    validate.arguments([{\n      name: 'line_id',\n      value: line_id,\n      type: 'number',\n      notEmpty: true,\n      optional: false\n    }]);\n    return transitApi.retrieveBusLineRoute(line_id).then(response => {\n      const features = response.features;\n      return features.map(({\n        properties: {\n          \"SENTIT\": direction_id,\n          \"DESTI_SENTIT\": direction_name\n        }\n      }) => {\n        return {\n          direction_id,\n          direction_name\n        };\n      });\n    });\n  },\n\n  retrieveBusStops(line_id, direction_id) {\n    validate.arguments([{\n      name: 'line_id',\n      value: line_id,\n      type: 'number',\n      notEmpty: true,\n      optional: false\n    }, {\n      name: 'direction_id',\n      value: direction_id,\n      type: 'string',\n      notEmpty: true,\n      optional: false\n    }]);\n\n    if (direction_id !== 'A' && direction_id !== 'T') {\n      throw new DirectionError('direction is not valid');\n    }\n\n    return transitApi.retrieveBusStops(line_id).then(response => {\n      const features = response.features;\n      let stops = [];\n      features.forEach(e => {\n        const _e$properties = e.properties,\n              stop_id = _e$properties[\"CODI_PARADA\"],\n              stop_name = _e$properties[\"NOM_PARADA\"],\n              direction = _e$properties[\"SENTIT\"];\n\n        if (direction === direction_id) {\n          stops.push({\n            stop_id,\n            stop_name\n          });\n        }\n      });\n      return stops;\n    });\n  },\n\n  upcomingBusesByStop(stop_id) {\n    validate.arguments([{\n      name: 'stop',\n      value: stop_id,\n      type: 'number',\n      notEmpty: true,\n      optional: false\n    }]);\n    let buses = [];\n    return iBusApi.retrieveStopId(stop_id).then(response => {\n      const ibus = response.data.ibus;\n      if (ibus.length === 0) throw new NoDataError('no data recived');\n      return ibus.map((bus, index) => {\n        const line = bus.line,\n              t_in_min = bus[\"t-in-min\"],\n              t_in_s = bus[\"t-in-s\"],\n              text_ca = bus[\"text-ca\"];\n        buses[index] = {\n          line,\n          t_in_min,\n          t_in_s,\n          text_ca\n        };\n        return transitApi.retrieveBusLine();\n      });\n    }).then(res => Promise.all(res).then(response => {\n      return response.map(({\n        features\n      }) => {\n        return features.map(({\n          properties: {\n            \"CODI_LINIA\": line_id,\n            \"NOM_LINIA\": name_line,\n            \"DESC_LINIA\": desc_line,\n            \"ORIGEN_LINIA\": origin_line,\n            \"DESTI_LINIA\": dest_line,\n            \"COLOR_LINIA\": color_line\n          }\n        }) => {\n          return {\n            line_id,\n            name_line,\n            desc_line,\n            origin_line,\n            dest_line,\n            color_line\n          };\n        });\n      });\n    })).then(resp => {\n      let upcomingBuses = [];\n      resp.map((arr, index) => {\n        let lineFind = false;\n        let i = 0;\n        let color_line;\n\n        while (i < arr.length && !lineFind) {\n          if (arr[i].name_line === buses[index].line) {\n            color_line = arr[i].color_line;\n            lineFind = true;\n          } else {\n            i++;\n          }\n        }\n\n        lineFind ? upcomingBuses.push({\n          line: buses[index].line,\n          t_in_min: buses[index].t_in_min,\n          t_in_s: buses[index].t_in_s,\n          text_ca: buses[index].text_ca,\n          color_line\n        }) : upcomingBuses.push({\n          line: buses[index].line,\n          t_in_min: buses[index].t_in_min,\n          t_in_s: buses[index].t_in_s,\n          text_ca: buses[index].text_ca,\n          color_line: '#000000'\n        });\n      });\n      return upcomingBuses;\n    });\n  },\n\n  upcomingBusesByStopAndLine(stop_id, line_id) {\n    validate.arguments([{\n      name: 'stop',\n      value: stop_id,\n      type: 'number',\n      notEmpty: true,\n      optional: false\n    }, {\n      name: 'line',\n      value: line_id,\n      type: 'number',\n      notEmpty: true,\n      optional: false\n    }]);\n    let buses = [];\n    debugger;\n    return iBusApi.retrieveLineId(stop_id, line_id).then(response => {\n      const ibus = response.data.ibus;\n      if (response.length === 0) throw new NoDataError('no data recived');\n      return response.map((bus, index) => {\n        const line_id = bus.line_id,\n              t_in_min = bus[\"t-in-min\"],\n              t_in_s = bus[\"t-in-s\"],\n              text_ca = bus[\"text-ca\"];\n        buses[index] = {\n          line_id,\n          t_in_min,\n          t_in_s,\n          text_ca\n        };\n        return transitApi.retrieveBusLine(line_id);\n      });\n    }).then(res => Promise.all(res).then(response => {\n      debugger;\n      return response.map(({\n        features\n      }) => {\n        return features.map(({\n          properties: {\n            \"CODI_LINIA\": line_id,\n            \"NOM_LINIA\": name_line,\n            \"DESC_LINIA\": desc_line,\n            \"ORIGEN_LINIA\": origin_line,\n            \"DESTI_LINIA\": dest_line,\n            \"COLOR_LINIA\": color_line\n          }\n        }) => {\n          return {\n            line_id,\n            name_line,\n            desc_line,\n            origin_line,\n            dest_line,\n            color_line\n          };\n        });\n      });\n    })).then(resp => {\n      debugger;\n      let upcomingBuses = [];\n      resp.map((arr, index) => {\n        upcomingBuses.push({\n          line: buses[index].line,\n          t_in_min: buses[index].t_in_min,\n          t_in_s: buses[index].t_in_s,\n          text_ca: buses[index].text_ca,\n          color_line: arr[0].color_line\n        });\n      });\n      return upcomingBuses;\n    });\n  }\n\n};\nexport default logic;","map":{"version":3,"sources":["/Users/didactor/Documents/skylab/bootcamp/collab/skylab-bootcamp-201904/staff/groups/aldi/siempre-tarde/src/logic/index.js"],"names":["normalize","validate","userApi","LogicError","DirectionError","PasswordError","NoDataError","iBusApi","transitApi","logic","__userId__","id","sessionStorage","userId","undefinedOrNull","__userToken__","token","userToken","isUserLoggedIn","registerUser","name","surname","email","password","password2","arguments","value","type","notEmpty","create","then","response","status","error","loginUser","authenticate","data","retrieveUser","retrieve","username","logoutUser","clear","addFavorites","retrieveFavorites","retrieveBusLines","line_id","optional","retrieveBusLine","features","map","properties","name_line","desc_line","origin_line","dest_line","color_line","retrieveBusLineRoute","direction_id","direction_name","retrieveBusStops","stops","forEach","e","stop_id","stop_name","direction","push","upcomingBusesByStop","buses","retrieveStopId","ibus","length","bus","index","line","t_in_min","t_in_s","text_ca","res","Promise","all","resp","upcomingBuses","arr","lineFind","i","upcomingBusesByStopAndLine","retrieveLineId"],"mappings":"AAAA,OAAOA,SAAP,MAAsB,qBAAtB;AACA,OAAOC,QAAP,MAAqB,oBAArB;AACA,OAAOC,OAAP,MAAoB,kBAApB;AACA,SAASC,UAAT,EAAqBC,cAArB,EAAqCC,aAArC,EAAoDC,WAApD,QAAuE,kBAAvE;AACA,OAAOC,OAAP,MAAoB,kBAApB;AACA,OAAOC,UAAP,MAAuB,qBAAvB;AAIA,MAAMC,KAAK,GAAG;AAEV,MAAIC,UAAJ,CAAeC,EAAf,EAAmB;AACfC,IAAAA,cAAc,CAACC,MAAf,GAAwBF,EAAxB;AACH,GAJS;;AAMV,MAAID,UAAJ,GAAiB;AACb,WAAOV,SAAS,CAACc,eAAV,CAA0BF,cAAc,CAACC,MAAzC,CAAP;AACH,GARS;;AAUV,MAAIE,aAAJ,CAAkBC,KAAlB,EAAyB;AACrBJ,IAAAA,cAAc,CAACK,SAAf,GAA2BD,KAA3B;AACH,GAZS;;AAcV,MAAID,aAAJ,GAAoB;AAChB,WAAOf,SAAS,CAACc,eAAV,CAA0BF,cAAc,CAACK,SAAzC,CAAP;AACH,GAhBS;;AAkBV,MAAIC,cAAJ,GAAqB;AACjB,WAAO,CAAC,EAAE,KAAKR,UAAL,IAAmB,KAAKK,aAA1B,CAAR;AACH,GApBS;;AAsBVI,EAAAA,YAAY,CAACC,IAAD,EAAOC,OAAP,EAAgBC,KAAhB,EAAuBC,QAAvB,EAAiCC,SAAjC,EAA4C;AAEpDvB,IAAAA,QAAQ,CAACwB,SAAT,CAAmB,CACf;AAAEL,MAAAA,IAAI,EAAE,MAAR;AAAgBM,MAAAA,KAAK,EAAEN,IAAvB;AAA6BO,MAAAA,IAAI,EAAE,QAAnC;AAA6CC,MAAAA,QAAQ,EAAE;AAAvD,KADe,EAEf;AAAER,MAAAA,IAAI,EAAE,SAAR;AAAmBM,MAAAA,KAAK,EAAEL,OAA1B;AAAmCM,MAAAA,IAAI,EAAE,QAAzC;AAAmDC,MAAAA,QAAQ,EAAE;AAA7D,KAFe,EAGf;AAAER,MAAAA,IAAI,EAAE,OAAR;AAAiBM,MAAAA,KAAK,EAAEJ,KAAxB;AAA+BK,MAAAA,IAAI,EAAE,QAArC;AAA+CC,MAAAA,QAAQ,EAAE;AAAzD,KAHe,EAIf;AAAER,MAAAA,IAAI,EAAE,UAAR;AAAoBM,MAAAA,KAAK,EAAEH,QAA3B;AAAqCI,MAAAA,IAAI,EAAE,QAA3C;AAAqDC,MAAAA,QAAQ,EAAE;AAA/D,KAJe,EAKf;AAAER,MAAAA,IAAI,EAAE,WAAR;AAAqBM,MAAAA,KAAK,EAAEF,SAA5B;AAAuCG,MAAAA,IAAI,EAAE,QAA7C;AAAuDC,MAAAA,QAAQ,EAAE;AAAjE,KALe,CAAnB;AAQA3B,IAAAA,QAAQ,CAACqB,KAAT,CAAeA,KAAf;AAEA,QAAIC,QAAQ,KAAKC,SAAjB,EAA4B,MAAM,IAAInB,aAAJ,CAAkB,sBAAlB,CAAN;AAE5B,WAAOH,OAAO,CAAC2B,MAAR,CAAeP,KAAf,EAAsBC,QAAtB,EAAgC;AAAEH,MAAAA,IAAF;AAAQC,MAAAA;AAAR,KAAhC,EACFS,IADE,CACGC,QAAQ,IAAI;AACd,UAAIA,QAAQ,CAACC,MAAT,KAAoB,IAAxB,EAA8B;AAE9B,YAAM,IAAI7B,UAAJ,CAAe4B,QAAQ,CAACE,KAAxB,CAAN;AACH,KALE,CAAP;AAMH,GA1CS;;AA4CVC,EAAAA,SAAS,CAACZ,KAAD,EAAQC,QAAR,EAAkB;AACvBtB,IAAAA,QAAQ,CAACwB,SAAT,CAAmB,CACf;AAAEL,MAAAA,IAAI,EAAE,OAAR;AAAiBM,MAAAA,KAAK,EAAEJ,KAAxB;AAA+BK,MAAAA,IAAI,EAAE,QAArC;AAA+CC,MAAAA,QAAQ,EAAE;AAAzD,KADe,EAEf;AAAER,MAAAA,IAAI,EAAE,UAAR;AAAoBM,MAAAA,KAAK,EAAEH,QAA3B;AAAqCI,MAAAA,IAAI,EAAE,QAA3C;AAAqDC,MAAAA,QAAQ,EAAE;AAA/D,KAFe,CAAnB;AAKA3B,IAAAA,QAAQ,CAACqB,KAAT,CAAeA,KAAf;AAEA,WAAOpB,OAAO,CAACiC,YAAR,CAAqBb,KAArB,EAA4BC,QAA5B,EACFO,IADE,CACGC,QAAQ,IAAI;AACd,UAAIA,QAAQ,CAACC,MAAT,KAAoB,IAAxB,EAA8B;AAAA,+BACMD,QADN,CAClBK,IADkB;AAAA,cACVzB,EADU,kBACVA,EADU;AAAA,cACNK,KADM,kBACNA,KADM;AAG1B,aAAKN,UAAL,GAAkBC,EAAlB;AACA,aAAKI,aAAL,GAAqBC,KAArB;AACH,OALD,MAKO,MAAM,IAAIb,UAAJ,CAAe4B,QAAQ,CAACE,KAAxB,CAAN;AACV,KARE,CAAP;AASH,GA7DS;;AA+DVI,EAAAA,YAAY,GAAG;AACX,WAAOnC,OAAO,CAACoC,QAAR,CAAiB,KAAK5B,UAAtB,EAAkC,KAAKK,aAAvC,EACFe,IADE,CACGC,QAAQ,IAAI;AACd,UAAIA,QAAQ,CAACC,MAAT,KAAoB,IAAxB,EAA8B;AAAA,gCAC2BD,QAD3B,CAClBK,IADkB;AAAA,cACVhB,IADU,mBACVA,IADU;AAAA,cACJC,OADI,mBACJA,OADI;AAAA,cACeC,KADf,mBACKiB,QADL;AAG1B,eAAO;AAAEnB,UAAAA,IAAF;AAAQC,UAAAA,OAAR;AAAiBC,UAAAA;AAAjB,SAAP;AACH,OAJD,MAIO,MAAM,IAAInB,UAAJ,CAAe4B,QAAQ,CAACE,KAAxB,CAAN;AACV,KAPE,CAAP;AAQH,GAxES;;AA0EVO,EAAAA,UAAU,GAAG;AACT5B,IAAAA,cAAc,CAAC6B,KAAf;AACH,GA5ES;;AA+EVC,EAAAA,YAAY,GAAG,CACX;AACH,GAjFS;;AAoFVC,EAAAA,iBAAiB,GAAG,CAChB;AACH,GAtFS;;AAyFVC,EAAAA,gBAAgB,CAACC,OAAD,EAAU;AAEtB5C,IAAAA,QAAQ,CAACwB,SAAT,CAAmB,CACf;AAAEL,MAAAA,IAAI,EAAE,SAAR;AAAmBM,MAAAA,KAAK,EAAEmB,OAA1B;AAAmClB,MAAAA,IAAI,EAAE,QAAzC;AAAmDC,MAAAA,QAAQ,EAAE,IAA7D;AAAmEkB,MAAAA,QAAQ,EAAE;AAA7E,KADe,CAAnB;AAIA,WAAOtC,UAAU,CAACuC,eAAX,CAA2BF,OAA3B,EACFf,IADE,CACGC,QAAQ,IAAI;AAAA,YACNiB,QADM,GACOjB,QADP,CACNiB,QADM;AAGd,aAAOA,QAAQ,CAACC,GAAT,CAAa,CAAC;AAAEC,QAAAA,UAAU,EAC7B;AAAE,wBAAmBL,OAArB;AACI,uBAAiBM,SADrB;AAEI,wBAAiBC,SAFrB;AAGI,0BAAiBC,WAHrB;AAII,yBAAiBC,SAJrB;AAKI,yBAAiBC;AALrB;AADiB,OAAD,KAQd;AACF,eAAO;AAAEV,UAAAA,OAAF;AAAWM,UAAAA,SAAX;AAAsBC,UAAAA,SAAtB;AAAiCC,UAAAA,WAAjC;AAA8CC,UAAAA,SAA9C;AAAyDC,UAAAA;AAAzD,SAAP;AACH,OAVM,CAAP;AAWH,KAfE,CAAP;AAgBH,GA/GS;;AAkHVC,EAAAA,oBAAoB,CAACX,OAAD,EAAU;AAE1B5C,IAAAA,QAAQ,CAACwB,SAAT,CAAmB,CACf;AAAEL,MAAAA,IAAI,EAAE,SAAR;AAAmBM,MAAAA,KAAK,EAAEmB,OAA1B;AAAmClB,MAAAA,IAAI,EAAE,QAAzC;AAAmDC,MAAAA,QAAQ,EAAE,IAA7D;AAAmEkB,MAAAA,QAAQ,EAAE;AAA7E,KADe,CAAnB;AAIA,WAAOtC,UAAU,CAACgD,oBAAX,CAAgCX,OAAhC,EACFf,IADE,CACGC,QAAQ,IAAI;AAAA,YACNiB,QADM,GACOjB,QADP,CACNiB,QADM;AAGd,aAAOA,QAAQ,CAACC,GAAT,CAAa,CAAC;AAAEC,QAAAA,UAAU,EAC7B;AAAE,oBAAmBO,YAArB;AACI,0BAAiBC;AADrB;AADiB,OAAD,KAId;AACF,eAAO;AAAED,UAAAA,YAAF;AAAgBC,UAAAA;AAAhB,SAAP;AACH,OANM,CAAP;AAOH,KAXE,CAAP;AAYH,GApIS;;AAuIVC,EAAAA,gBAAgB,CAACd,OAAD,EAAUY,YAAV,EAAwB;AAEpCxD,IAAAA,QAAQ,CAACwB,SAAT,CAAmB,CACf;AAAEL,MAAAA,IAAI,EAAE,SAAR;AAAmBM,MAAAA,KAAK,EAAEmB,OAA1B;AAAmClB,MAAAA,IAAI,EAAE,QAAzC;AAAmDC,MAAAA,QAAQ,EAAE,IAA7D;AAAmEkB,MAAAA,QAAQ,EAAE;AAA7E,KADe,EAEf;AAAE1B,MAAAA,IAAI,EAAE,cAAR;AAAwBM,MAAAA,KAAK,EAAE+B,YAA/B;AAA6C9B,MAAAA,IAAI,EAAE,QAAnD;AAA6DC,MAAAA,QAAQ,EAAE,IAAvE;AAA6EkB,MAAAA,QAAQ,EAAE;AAAvF,KAFe,CAAnB;;AAKA,QAAIW,YAAY,KAAK,GAAjB,IAAwBA,YAAY,KAAK,GAA7C,EAAkD;AAAE,YAAM,IAAIrD,cAAJ,CAAmB,wBAAnB,CAAN;AAAoD;;AAGxG,WAAOI,UAAU,CAACmD,gBAAX,CAA4Bd,OAA5B,EACFf,IADE,CACGC,QAAQ,IAAI;AAAA,YACNiB,QADM,GACOjB,QADP,CACNiB,QADM;AAGd,UAAIY,KAAK,GAAG,EAAZ;AAEAZ,MAAAA,QAAQ,CAACa,OAAT,CAAiBC,CAAC,IAAI;AAAA,8BAMdA,CANc,CACVZ,UADU;AAAA,cAEKa,OAFL,iBAEZ,aAFY;AAAA,cAGKC,SAHL,iBAGV,YAHU;AAAA,cAIKC,SAJL,iBAIV,QAJU;;AAOlB,YAAIA,SAAS,KAAKR,YAAlB,EAAgC;AAC5BG,UAAAA,KAAK,CAACM,IAAN,CAAW;AAAEH,YAAAA,OAAF;AAAWC,YAAAA;AAAX,WAAX;AACH;AAEJ,OAXD;AAaA,aAAOJ,KAAP;AACH,KApBE,CAAP;AAqBH,GAtKS;;AAyKVO,EAAAA,mBAAmB,CAACJ,OAAD,EAAU;AAEzB9D,IAAAA,QAAQ,CAACwB,SAAT,CAAmB,CACf;AAAEL,MAAAA,IAAI,EAAE,MAAR;AAAgBM,MAAAA,KAAK,EAAEqC,OAAvB;AAAgCpC,MAAAA,IAAI,EAAE,QAAtC;AAAgDC,MAAAA,QAAQ,EAAE,IAA1D;AAAgEkB,MAAAA,QAAQ,EAAE;AAA1E,KADe,CAAnB;AAIA,QAAIsB,KAAK,GAAG,EAAZ;AACA,WAAO7D,OAAO,CAAC8D,cAAR,CAAuBN,OAAvB,EACFjC,IADE,CACGC,QAAQ,IAAI;AAAA,YAEEuC,IAFF,GAEavC,QAFb,CAENK,IAFM,CAEEkC,IAFF;AAId,UAAIA,IAAI,CAACC,MAAL,KAAgB,CAApB,EAAuB,MAAM,IAAIjE,WAAJ,CAAgB,iBAAhB,CAAN;AAEvB,aAAOgE,IAAI,CAACrB,GAAL,CAAS,CAACuB,GAAD,EAAMC,KAAN,KAAgB;AAAA,cAEpBC,IAFoB,GAEiDF,GAFjD,CAEpBE,IAFoB;AAAA,cAEFC,QAFE,GAEiDH,GAFjD,CAEd,UAFc;AAAA,cAEkBI,MAFlB,GAEiDJ,GAFjD,CAEQ,QAFR;AAAA,cAEqCK,OAFrC,GAEiDL,GAFjD,CAE0B,SAF1B;AAI5BJ,QAAAA,KAAK,CAACK,KAAD,CAAL,GAAc;AAAEC,UAAAA,IAAF;AAAQC,UAAAA,QAAR;AAAkBC,UAAAA,MAAlB;AAA0BC,UAAAA;AAA1B,SAAd;AAEA,eAAOrE,UAAU,CAACuC,eAAX,EAAP;AACH,OAPM,CAAP;AAQH,KAfE,EAgBFjB,IAhBE,CAgBGgD,GAAG,IAAIC,OAAO,CAACC,GAAR,CAAYF,GAAZ,EAAiBhD,IAAjB,CAAsBC,QAAQ,IAAI;AAC3C,aAAOA,QAAQ,CAACkB,GAAT,CAAa,CAAC;AAACD,QAAAA;AAAD,OAAD,KAAgB;AAChC,eAAOA,QAAQ,CAACC,GAAT,CAAa,CAAC;AAACC,UAAAA,UAAU,EAC5B;AAAE,0BAAmBL,OAArB;AACI,yBAAiBM,SADrB;AAEI,0BAAiBC,SAFrB;AAGI,4BAAiBC,WAHrB;AAII,2BAAiBC,SAJrB;AAKI,2BAAiBC;AALrB;AADiB,SAAD,KAQd;AACF,iBAAO;AAAEV,YAAAA,OAAF;AAAWM,YAAAA,SAAX;AAAsBC,YAAAA,SAAtB;AAAiCC,YAAAA,WAAjC;AAA8CC,YAAAA,SAA9C;AAAyDC,YAAAA;AAAzD,WAAP;AACH,SAVM,CAAP;AAWC,OAZE,CAAP;AAaC,KAdQ,CAhBV,EAgCFzB,IAhCE,CAgCGmD,IAAI,IAAI;AACV,UAAIC,aAAa,GAAG,EAApB;AACAD,MAAAA,IAAI,CAAChC,GAAL,CAAS,CAACkC,GAAD,EAAMV,KAAN,KAAgB;AACrB,YAAIW,QAAQ,GAAG,KAAf;AACA,YAAIC,CAAC,GAAG,CAAR;AACA,YAAI9B,UAAJ;;AACA,eAAO8B,CAAC,GAAGF,GAAG,CAACZ,MAAR,IAAkB,CAACa,QAA1B,EAAoC;AAChC,cAAID,GAAG,CAACE,CAAD,CAAH,CAAOlC,SAAP,KAAqBiB,KAAK,CAACK,KAAD,CAAL,CAAaC,IAAtC,EAA4C;AACxCnB,YAAAA,UAAU,GAAG4B,GAAG,CAACE,CAAD,CAAH,CAAO9B,UAApB;AACA6B,YAAAA,QAAQ,GAAG,IAAX;AACH,WAHD,MAIK;AAACC,YAAAA,CAAC;AAAG;AACb;;AACDD,QAAAA,QAAQ,GAAGF,aAAa,CAAChB,IAAd,CAAmB;AAACQ,UAAAA,IAAI,EAAEN,KAAK,CAACK,KAAD,CAAL,CAAaC,IAApB;AAA0BC,UAAAA,QAAQ,EAAEP,KAAK,CAACK,KAAD,CAAL,CAAaE,QAAjD;AAA2DC,UAAAA,MAAM,EAAER,KAAK,CAACK,KAAD,CAAL,CAAaG,MAAhF;AAAwFC,UAAAA,OAAO,EAAET,KAAK,CAACK,KAAD,CAAL,CAAaI,OAA9G;AAAuHtB,UAAAA;AAAvH,SAAnB,CAAH,GACA2B,aAAa,CAAChB,IAAd,CAAmB;AAACQ,UAAAA,IAAI,EAAEN,KAAK,CAACK,KAAD,CAAL,CAAaC,IAApB;AAA0BC,UAAAA,QAAQ,EAAEP,KAAK,CAACK,KAAD,CAAL,CAAaE,QAAjD;AAA2DC,UAAAA,MAAM,EAAER,KAAK,CAACK,KAAD,CAAL,CAAaG,MAAhF;AAAwFC,UAAAA,OAAO,EAAET,KAAK,CAACK,KAAD,CAAL,CAAaI,OAA9G;AAAuHtB,UAAAA,UAAU,EAAE;AAAnI,SAAnB,CADR;AAGH,OAdD;AAeA,aAAO2B,aAAP;AACH,KAlDE,CAAP;AAmDH,GAnOS;;AAsOVI,EAAAA,0BAA0B,CAACvB,OAAD,EAAUlB,OAAV,EAAmB;AAEzC5C,IAAAA,QAAQ,CAACwB,SAAT,CAAmB,CACf;AAAEL,MAAAA,IAAI,EAAE,MAAR;AAAgBM,MAAAA,KAAK,EAAEqC,OAAvB;AAAgCpC,MAAAA,IAAI,EAAE,QAAtC;AAAgDC,MAAAA,QAAQ,EAAE,IAA1D;AAAgEkB,MAAAA,QAAQ,EAAE;AAA1E,KADe,EAEf;AAAE1B,MAAAA,IAAI,EAAE,MAAR;AAAgBM,MAAAA,KAAK,EAAEmB,OAAvB;AAAgClB,MAAAA,IAAI,EAAE,QAAtC;AAAgDC,MAAAA,QAAQ,EAAE,IAA1D;AAAgEkB,MAAAA,QAAQ,EAAE;AAA1E,KAFe,CAAnB;AAKA,QAAIsB,KAAK,GAAG,EAAZ;AACA;AACA,WAAO7D,OAAO,CAACgF,cAAR,CAAuBxB,OAAvB,EAAgClB,OAAhC,EACFf,IADE,CACGC,QAAQ,IAAI;AAAA,YAEDuC,IAFC,GAEQvC,QAFR,CAEPK,IAFO,CAEDkC,IAFC;AAId,UAAIvC,QAAQ,CAACwC,MAAT,KAAoB,CAAxB,EAA2B,MAAM,IAAIjE,WAAJ,CAAgB,iBAAhB,CAAN;AAE3B,aAAOyB,QAAQ,CAACkB,GAAT,CAAa,CAACuB,GAAD,EAAMC,KAAN,KAAgB;AAAA,cAExB5B,OAFwB,GAEgD2B,GAFhD,CAExB3B,OAFwB;AAAA,cAEH8B,QAFG,GAEgDH,GAFhD,CAEf,UAFe;AAAA,cAEiBI,MAFjB,GAEgDJ,GAFhD,CAEO,QAFP;AAAA,cAEoCK,OAFpC,GAEgDL,GAFhD,CAEyB,SAFzB;AAIhCJ,QAAAA,KAAK,CAACK,KAAD,CAAL,GAAc;AAAE5B,UAAAA,OAAF;AAAW8B,UAAAA,QAAX;AAAqBC,UAAAA,MAArB;AAA6BC,UAAAA;AAA7B,SAAd;AAEA,eAAOrE,UAAU,CAACuC,eAAX,CAA2BF,OAA3B,CAAP;AACH,OAPM,CAAP;AAQH,KAfE,EAgBFf,IAhBE,CAgBGgD,GAAG,IAAIC,OAAO,CAACC,GAAR,CAAYF,GAAZ,EAAiBhD,IAAjB,CAAsBC,QAAQ,IAAI;AAC3C;AACA,aAAOA,QAAQ,CAACkB,GAAT,CAAa,CAAC;AAACD,QAAAA;AAAD,OAAD,KAAgB;AAChC,eAAOA,QAAQ,CAACC,GAAT,CAAa,CAAC;AAACC,UAAAA,UAAU,EAC5B;AAAE,0BAAmBL,OAArB;AACI,yBAAiBM,SADrB;AAEI,0BAAiBC,SAFrB;AAGI,4BAAiBC,WAHrB;AAII,2BAAiBC,SAJrB;AAKI,2BAAiBC;AALrB;AADiB,SAAD,KAQd;AAAC,iBAAO;AAAEV,YAAAA,OAAF;AAAWM,YAAAA,SAAX;AAAsBC,YAAAA,SAAtB;AAAiCC,YAAAA,WAAjC;AAA8CC,YAAAA,SAA9C;AAAyDC,YAAAA;AAAzD,WAAP;AAA8E,SAR9E,CAAP;AASC,OAVE,CAAP;AAWC,KAbQ,CAhBV,EA+BFzB,IA/BE,CA+BGmD,IAAI,IAAI;AACV;AACA,UAAIC,aAAa,GAAG,EAApB;AACAD,MAAAA,IAAI,CAAChC,GAAL,CAAS,CAACkC,GAAD,EAAMV,KAAN,KAAgB;AACrBS,QAAAA,aAAa,CAAChB,IAAd,CAAmB;AAACQ,UAAAA,IAAI,EAAEN,KAAK,CAACK,KAAD,CAAL,CAAaC,IAApB;AAA0BC,UAAAA,QAAQ,EAAEP,KAAK,CAACK,KAAD,CAAL,CAAaE,QAAjD;AAA2DC,UAAAA,MAAM,EAAER,KAAK,CAACK,KAAD,CAAL,CAAaG,MAAhF;AAAwFC,UAAAA,OAAO,EAAET,KAAK,CAACK,KAAD,CAAL,CAAaI,OAA9G;AAAuHtB,UAAAA,UAAU,EAAG4B,GAAG,CAAC,CAAD,CAAH,CAAO5B;AAA3I,SAAnB;AACH,OAFD;AAGA,aAAO2B,aAAP;AACH,KAtCE,CAAP;AAuCH;;AAtRS,CAAd;AA0RA,eAAezE,KAAf","sourcesContent":["import normalize from '../common/normalize'\nimport validate from '../common/validate'\nimport userApi from '../data/user-api'\nimport { LogicError, DirectionError, PasswordError, NoDataError } from '../common/errors'\nimport iBusApi from '../data/ibus-api'\nimport transitApi from '../data/transit-api'\n\n\n\nconst logic = {\n\n    set __userId__(id) {\n        sessionStorage.userId = id\n    },\n\n    get __userId__() {\n        return normalize.undefinedOrNull(sessionStorage.userId)\n    },\n\n    set __userToken__(token) {\n        sessionStorage.userToken = token\n    },\n\n    get __userToken__() {\n        return normalize.undefinedOrNull(sessionStorage.userToken)\n    },\n\n    get isUserLoggedIn() {\n        return !!(this.__userId__ && this.__userToken__)\n    },\n\n    registerUser(name, surname, email, password, password2) {\n\n        validate.arguments([\n            { name: 'name', value: name, type: 'string', notEmpty: true },\n            { name: 'surname', value: surname, type: 'string', notEmpty: true },\n            { name: 'email', value: email, type: 'string', notEmpty: true },\n            { name: 'password', value: password, type: 'string', notEmpty: true },\n            { name: 'password2', value: password2, type: 'string', notEmpty: true }\n        ])\n\n        validate.email(email)\n\n        if (password !== password2) throw new PasswordError(\"Password don't match\")\n\n        return userApi.create(email, password, { name, surname })\n            .then(response => {\n                if (response.status === 'OK') return\n\n                throw new LogicError(response.error)\n            })\n    },\n\n    loginUser(email, password) {\n        validate.arguments([\n            { name: 'email', value: email, type: 'string', notEmpty: true },\n            { name: 'password', value: password, type: 'string', notEmpty: true }\n        ])\n\n        validate.email(email)\n\n        return userApi.authenticate(email, password)\n            .then(response => {\n                if (response.status === 'OK') {\n                    const { data: { id, token } } = response\n\n                    this.__userId__ = id\n                    this.__userToken__ = token\n                } else throw new LogicError(response.error)\n            })\n    },\n\n    retrieveUser() {\n        return userApi.retrieve(this.__userId__, this.__userToken__)\n            .then(response => {\n                if (response.status === 'OK') {\n                    const { data: { name, surname, username: email } } = response\n\n                    return { name, surname, email }\n                } else throw new LogicError(response.error)\n            })\n    },\n\n    logoutUser() {\n        sessionStorage.clear()\n    },\n\n\n    addFavorites() {\n        //TODO\n    },\n\n\n    retrieveFavorites() {\n        //TODO\n    },\n\n\n    retrieveBusLines(line_id) {\n\n        validate.arguments([\n            { name: 'line_id', value: line_id, type: 'number', notEmpty: true, optional: true }\n        ])\n\n        return transitApi.retrieveBusLine(line_id)\n            .then(response => {\n                const { features } = response\n\n                return features.map(({ properties:\n                    { \"CODI_LINIA\"     : line_id,\n                        \"NOM_LINIA\"    : name_line,\n                        \"DESC_LINIA\"   : desc_line,\n                        \"ORIGEN_LINIA\" : origin_line,\n                        \"DESTI_LINIA\"  : dest_line,\n                        \"COLOR_LINIA\"  : color_line\n                    }\n                }) => {\n                    return { line_id, name_line, desc_line, origin_line, dest_line, color_line }\n                })\n            })\n    },\n\n\n    retrieveBusLineRoute(line_id) {\n\n        validate.arguments([\n            { name: 'line_id', value: line_id, type: 'number', notEmpty: true, optional: false }\n        ])\n\n        return transitApi.retrieveBusLineRoute(line_id)\n            .then(response => {\n                const { features } = response\n\n                return features.map(({ properties:\n                    { \"SENTIT\"         : direction_id,\n                        \"DESTI_SENTIT\" : direction_name\n                    }\n                }) => {\n                    return { direction_id, direction_name }\n                })\n            })\n    },\n\n\n    retrieveBusStops(line_id, direction_id) {\n\n        validate.arguments([\n            { name: 'line_id', value: line_id, type: 'number', notEmpty: true, optional: false },\n            { name: 'direction_id', value: direction_id, type: 'string', notEmpty: true, optional: false }\n        ])\n\n        if (direction_id !== 'A' && direction_id !== 'T') { throw new DirectionError('direction is not valid') }\n\n\n        return transitApi.retrieveBusStops(line_id)\n            .then(response => {\n                const { features } = response\n\n                let stops = []\n\n                features.forEach(e => {\n                    const { properties:\n                        { \"CODI_PARADA\"  : stop_id,\n                            \"NOM_PARADA\" : stop_name,\n                            \"SENTIT\"     : direction\n                        }\n                    } = e\n                    if (direction === direction_id) {\n                        stops.push({ stop_id, stop_name })\n                    }\n\n                })\n\n                return stops\n            })\n    },\n\n\n    upcomingBusesByStop(stop_id) {\n\n        validate.arguments([\n            { name: 'stop', value: stop_id, type: 'number', notEmpty: true, optional: false }\n        ])\n\n        let buses = []\n        return iBusApi.retrieveStopId(stop_id)\n            .then(response => {\n                \n                const { data: { ibus } } = response\n\n                if (ibus.length === 0) throw new NoDataError('no data recived')\n\n                return ibus.map((bus, index) => {\n\n                    const { line, \"t-in-min\": t_in_min, \"t-in-s\": t_in_s, \"text-ca\": text_ca } = bus\n\n                    buses[index]= { line, t_in_min, t_in_s, text_ca }\n\n                    return transitApi.retrieveBusLine()\n                })\n            })\n            .then(res => Promise.all(res).then(response => {\n                return response.map(({features}) => {\n                    return features.map(({properties:\n                        { \"CODI_LINIA\"     : line_id,\n                            \"NOM_LINIA\"    : name_line,\n                            \"DESC_LINIA\"   : desc_line,\n                            \"ORIGEN_LINIA\" : origin_line,\n                            \"DESTI_LINIA\"  : dest_line,\n                            \"COLOR_LINIA\"  : color_line\n                        }\n                    }) => {\n                        return { line_id, name_line, desc_line, origin_line, dest_line, color_line }\n                    })\n                    }) \n                })  \n            )\n            .then(resp => {\n                let upcomingBuses = []\n                resp.map((arr, index )=> {\n                    let lineFind = false\n                    let i = 0\n                    let color_line\n                    while (i < arr.length && !lineFind) {\n                        if (arr[i].name_line === buses[index].line) {\n                            color_line = arr[i].color_line\n                            lineFind = true\n                        }\n                        else {i++}\n                    }\n                    lineFind ? upcomingBuses.push({line: buses[index].line, t_in_min: buses[index].t_in_min, t_in_s: buses[index].t_in_s, text_ca: buses[index].text_ca, color_line }) :\n                            upcomingBuses.push({line: buses[index].line, t_in_min: buses[index].t_in_min, t_in_s: buses[index].t_in_s, text_ca: buses[index].text_ca, color_line: '#000000'}) \n\n                })\n                return upcomingBuses\n            })\n    },\n\n\n    upcomingBusesByStopAndLine(stop_id, line_id) {\n\n        validate.arguments([\n            { name: 'stop', value: stop_id, type: 'number', notEmpty: true, optional: false },\n            { name: 'line', value: line_id, type: 'number', notEmpty: true, optional: false }\n        ])\n\n        let buses = []\n        debugger\n        return iBusApi.retrieveLineId(stop_id, line_id)\n            .then(response => {\n\n                const {data:{ibus}} = response\n\n                if (response.length === 0) throw new NoDataError('no data recived')\n\n                return response.map((bus, index) => {\n\n                    const { line_id, \"t-in-min\": t_in_min, \"t-in-s\": t_in_s, \"text-ca\": text_ca } = bus\n\n                    buses[index]= { line_id, t_in_min, t_in_s, text_ca }\n\n                    return transitApi.retrieveBusLine(line_id)\n                })\n            })\n            .then(res => Promise.all(res).then(response => {\n                debugger\n                return response.map(({features}) => {\n                    return features.map(({properties:\n                        { \"CODI_LINIA\"     : line_id,\n                            \"NOM_LINIA\"    : name_line,\n                            \"DESC_LINIA\"   : desc_line,\n                            \"ORIGEN_LINIA\" : origin_line,\n                            \"DESTI_LINIA\"  : dest_line,\n                            \"COLOR_LINIA\"  : color_line\n                        }\n                    }) => {return { line_id, name_line, desc_line, origin_line, dest_line, color_line } })\n                    }) \n                })  \n            )\n            .then(resp => {\n                debugger\n                let upcomingBuses = []\n                resp.map((arr, index )=> {\n                    upcomingBuses.push({line: buses[index].line, t_in_min: buses[index].t_in_min, t_in_s: buses[index].t_in_s, text_ca: buses[index].text_ca, color_line : arr[0].color_line }) \n                })       \n                return upcomingBuses \n            })         \n    }\n\n}\n\nexport default logic"]},"metadata":{},"sourceType":"module"}